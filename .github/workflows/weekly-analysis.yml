# ============================================================================
# Weekly Portfolio Analysis Pipeline
# ============================================================================
# Runs the full R analysis pipeline every Saturday at 6 AM UTC
# This updates the portfolio selections with fresh market data.
#
# Schedule: Every Saturday at 6:00 AM UTC
#   - 10:00 PM Friday (Pacific)
#   - 1:00 AM Saturday (Eastern)
#
# What it does:
#   1. Downloads latest stock prices (5 years of data)
#   2. Screens for high Sharpe ratio candidates
#   3. Selects final 12-stock portfolio
#   4. Validates with Ichimoku signals
#   5. Calculates optimal weights
#   6. Runs walk-forward validation
#   7. Exports data for web app

name: Weekly Portfolio Analysis

on:
  # Run every Saturday at 6:00 AM UTC
  schedule:
    - cron: '0 6 * * 6'

  # Also allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  run-analysis:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up R environment
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.0'

      # Cache R packages to speed up builds
      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ hashFiles('**/install_packages.R') }}
          restore-keys: |
            ${{ runner.os }}-r-

      # Install system dependencies (needed for some R packages)
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      # Install R packages
      - name: Install R packages
        run: |
          Rscript -e "
            install.packages(c(
              'dplyr',
              'tidyr',
              'lubridate',
              'ggplot2',
              'quantmod',
              'TTR',
              'quadprog',
              'gridExtra'
            ), repos = 'https://cloud.r-project.org')
          "

      # Run Module 1: Download stock data
      - name: Module 1 - Download Stock Data
        run: Rscript 01_download_stock_data.R
        timeout-minutes: 60

      # Run Module 2: Screen candidates
      - name: Module 2 - Screen Candidates
        run: Rscript 02_screen_candidates.R

      # Run Module 3: Select portfolio
      - name: Module 3 - Select Portfolio
        run: Rscript 03_select_portfolio.R

      # Run Module 4: Ichimoku validation
      - name: Module 4 - Ichimoku Validation
        run: Rscript 04_ichimoku_validation.R

      # Run Module 5: Portfolio optimization
      - name: Module 5 - Portfolio Optimization
        run: Rscript 05_portfolio_optimization.R

      # Run Module 6: Walk-forward validation
      - name: Module 6 - Backtest Validation
        run: Rscript 06_backtest_validation.R

      # Export data for web app
      - name: Export data for web app
        run: |
          Rscript webapp/db/export_r_data.R
          Rscript webapp/db/export_ichimoku_data.R

      # Commit updated data back to repo
      - name: Commit updated analysis
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add analysis/
          git add webapp/db/seed_data/
          git add metadata/
          git diff --staged --quiet || git commit -m "Weekly analysis update - $(date +'%Y-%m-%d')"
          git push
